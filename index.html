<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SUPER ADMIN MACCA - DRIVER HISTORY READY</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #D4AF37; --dark: #000000; --card: #111111; }
        body { background-color: var(--dark); color: #ffffff; font-family: 'Plus Jakarta Sans', sans-serif; overflow-x: hidden; }
        .nav-active { color: var(--gold); background: rgba(212, 175, 55, 0.1); border-top: 2px solid var(--gold); }
        .page-content { display: none; }
        .page-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        .stat-card { background: var(--card); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; padding: 20px; }
        .tab-btn { flex: 1; padding: 10px; font-size: 9px; font-weight: 800; color: #555; border-radius: 10px; transition: 0.3s; }
        .tab-btn.active { color: var(--gold); background: rgba(212, 175, 55, 0.1); border: 1px solid rgba(212,175,55,0.2); }
        select, input[type="date"] { background: #1a1a1a; border: 1px solid #333; color: white; border-radius: 12px; padding: 12px; width: 100%; outline: none; font-size: 13px; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        .btn-update { position: fixed; bottom: 85px; right: 20px; z-index: 1000; background: rgba(255,255,255,0.1); backdrop-blur: md; color: white; font-size: 8px; font-weight: 800; padding: 8px 12px; border-radius: 50px; border: 1px solid rgba(255,255,255,0.1); opacity: 0.4; }
        .btn-update:active { opacity: 1; background: var(--gold); color: black; }
    </style>
</head>
<body class="antialiased pb-28">

    <button onclick="paksaUpdateSistem()" class="btn-update uppercase">
        <i class="fas fa-sync-alt mr-1"></i> Update Sistem
    </button>

    <header class="p-6 flex justify-between items-center sticky top-0 bg-black/90 backdrop-blur-md z-50 border-b border-white/5">
        <h1 class="text-xl font-black italic uppercase">MACCA <span style="color:var(--gold)">ADMIN</span></h1>
        <div class="flex gap-3">
            <span id="sync-indicator" class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse mt-2"></span>
        </div>
    </header>

    <main id="page-dashboard" class="page-content active p-6 space-y-6">
        <div class="stat-card border-l-4 border-gold">
            <p class="text-[10px] font-black text-slate-500 uppercase mb-1">Total Kopi (2025)</p>
            <h2 id="dash-kopi-total" class="text-4xl font-black italic text-gold">Rp 0</h2>
        </div>

        <div class="grid grid-cols-2 gap-4">
            <div class="stat-card text-center border-t-2 border-yellow-500/20">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Stok Ayam</p>
                <h4 id="dash-ayam" class="text-4xl font-black italic text-yellow-500">--</h4>
                <p class="text-[8px] text-zinc-600 mt-1 italic uppercase">V13.4 Sync</p>
            </div>
            <div class="stat-card text-center border-t-2 border-emerald-500/20">
                <p class="text-[9px] font-bold text-slate-500 uppercase mb-1">Stok Ikan</p>
                <h4 id="dash-ikan" class="text-4xl font-black italic text-emerald-500">--</h4>
                <p class="text-[8px] text-zinc-600 mt-1 italic uppercase">V13.4 Sync</p>
            </div>
        </div>

        <div class="stat-card border-l-4 border-blue-500 flex justify-between items-center">
            <div>
                <p class="text-[10px] font-black text-slate-500 uppercase mb-1">Total Order Laundry</p>
                <h4 id="dash-laundry-count" class="text-2xl font-black italic">0</h4>
            </div>
            <i class="fas fa-clipboard-list text-blue-500 text-2xl opacity-20"></i>
        </div>
    </main>

    <main id="page-kopi" class="page-content p-6 space-y-6">
        <div class="flex bg-zinc-900/50 p-1 rounded-xl">
            <button onclick="setModeKopi('hari')" id="k-tab-hari" class="tab-btn active uppercase">Harian</button>
            <button onclick="setModeKopi('bulan')" id="k-tab-bulan" class="tab-btn uppercase">Bulanan</button>
            <button onclick="setModeKopi('tahun')" id="k-tab-tahun" class="tab-btn uppercase">Tahunan</button>
        </div>
        <div class="stat-card">
            <div id="k-wrap-hari"><input type="date" id="k-input-hari" onchange="renderKopi()"></div>
            <div id="k-wrap-bt" class="hidden grid grid-cols-2 gap-2">
                <select id="k-input-bulan" onchange="renderKopi()">
                    <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option><option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option><option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option><option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
                </select>
                <select id="k-input-tahun" onchange="renderKopi()"></select>
            </div>
        </div>
        <div class="text-center bg-zinc-900/40 p-5 rounded-2xl border border-white/5">
            <h2 id="k-total-display" class="text-4xl font-black text-gold italic">Rp 0</h2>
            <p class="text-[10px] font-bold text-slate-500 uppercase mt-1">Revenue Kopi</p>
        </div>
        <div id="list-kopi" class="space-y-3"></div>
    </main>

    <main id="page-laundry" class="page-content p-6 space-y-6">
        <div class="flex bg-zinc-900/50 p-1 rounded-xl">
            <button onclick="setLaundryMode('hari')" id="l-tab-hari" class="tab-btn active uppercase">Rekap Hari Ini</button>
            <button onclick="setLaundryMode('bulan')" id="l-tab-bulan" class="tab-btn uppercase">Laporan Bulanan</button>
        </div>

        <div class="stat-card">
            <div id="l-wrap-hari">
                <input type="date" id="l-input-date" onchange="renderLaundry()">
            </div>
            <div id="l-wrap-bulan" class="hidden grid grid-cols-2 gap-2">
                <select id="l-select-bulan" onchange="renderLaundry()">
                    <option value="0">Januari</option><option value="1">Februari</option><option value="2">Maret</option><option value="3">April</option><option value="4">Mei</option><option value="5">Juni</option><option value="6">Juli</option><option value="7">Agustus</option><option value="8">September</option><option value="9">Oktober</option><option value="10">November</option><option value="11">Desember</option>
                </select>
                <select id="l-select-tahun" onchange="renderLaundry()"></select>
            </div>
        </div>

        <div>
            <h3 class="text-[10px] font-black text-gold uppercase mb-3 px-1 tracking-widest">Performansi Driver</h3>
            <div id="driver-recap" class="grid grid-cols-1 gap-3"></div>
        </div>

        <div id="l-history-section">
            <h3 class="text-[10px] font-black text-slate-500 uppercase mb-3 px-1 tracking-widest">Riwayat Driver</h3>
            <div id="list-laundry" class="space-y-4"></div>
        </div>
    </main>

    <nav class="fixed bottom-0 left-0 right-0 z-50 bg-black/95 border-t border-white/5 flex justify-around p-3 backdrop-blur-xl">
        <button onclick="switchPage('dashboard', this)" class="flex flex-col items-center gap-1 nav-active w-full">
            <i class="fas fa-home"></i><span class="text-[9px] font-bold uppercase">Home</span>
        </button>
        <button onclick="switchPage('kopi', this)" class="flex flex-col items-center gap-1 text-slate-500 w-full">
            <i class="fas fa-coffee"></i><span class="text-[9px] font-bold uppercase">Kopi</span>
        </button>
        <button onclick="switchPage('laundry', this)" class="flex flex-col items-center gap-1 text-slate-500 w-full">
            <i class="fas fa-tshirt"></i><span class="text-[9px] font-bold uppercase">Laundry</span>
        </button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot, query, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        const conf = { apiKey: "AIzaSyAf4pkzvpCuzmXquzIoCDXLAr6-_l3i8O0", projectId: "kopi-shaka" };
        const app = initializeApp(conf);
        const db = getFirestore(app);
        window.allKopi = [];
        onSnapshot(query(collection(db, "transactions"), orderBy("tgl", "desc")), (snap) => {
            window.allKopi = snap.docs.map(doc => doc.data());
            const rev = window.allKopi.filter(t => new Date(t.tgl).getFullYear() === 2025).reduce((a,b) => a+(b.total||0),0);
            document.getElementById('dash-kopi-total').innerText = "Rp " + rev.toLocaleString();
            if(window.renderKopi) window.renderKopi();
        });
    </script>

    <script>
        const configStok = { apiKey: "AIzaSyCCmKgOnBFpluEKuycYjrBRm4zbxrHI1P8", databaseURL: "https://stocklistmacca-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const configLaundry = { apiKey: "AIzaSyA-1GyDIS77tlL0vpiZS_ZLvx1S71TnkQU", databaseURL: "https://awwabim-laundry-default-rtdb.firebaseio.com" };
        
        firebase.initializeApp(configStok, "STOK");
        firebase.initializeApp(configLaundry, "LAUNDRY");
        const dbStok = firebase.app("STOK").database();
        const dbLaundry = firebase.app("LAUNDRY").database();

        let rawLaundry = [];
        let laundryMode = 'hari';

        dbStok.ref('stok_macca_v9').on('value', snap => {
            let sA = 0, sI = 0;
            snap.forEach(c => {
                const i = c.val();
                const add = (i.status === 'Masuk' || i.status === 'Retur') ? i.qty : -i.qty;
                i.type === 'Ayam' ? sA += add : sI += add;
            });
            document.getElementById('dash-ayam').innerText = sA;
            document.getElementById('dash-ikan').innerText = sI;
        });

        dbLaundry.ref('Pesanan').on('value', snap => {
            rawLaundry = [];
            snap.forEach(c => { rawLaundry.push(c.val()); });
            document.getElementById('dash-laundry-count').innerText = rawLaundry.length;
            renderLaundry();
        });

        window.setLaundryMode = (m) => {
            laundryMode = m;
            document.querySelectorAll('#page-laundry .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('l-tab-'+m).classList.add('active');
            document.getElementById('l-wrap-hari').classList.toggle('hidden', m !== 'hari');
            document.getElementById('l-wrap-bulan').classList.toggle('hidden', m === 'hari');
            document.getElementById('l-history-section').classList.toggle('hidden', m === 'bulan');
            renderLaundry();
        };

        window.renderLaundry = () => {
            const list = document.getElementById('list-laundry');
            const recap = document.getElementById('driver-recap');
            list.innerHTML = ''; recap.innerHTML = '';
            
            let stats = {};
            const hVal = document.getElementById('l-input-date').value;
            const bVal = parseInt(document.getElementById('l-select-bulan').value);
            const tVal = parseInt(document.getElementById('l-select-tahun').value);

            const filtered = rawLaundry.filter(o => {
                const d = new Date(o.mulai);
                if (laundryMode === 'hari') return d.toDateString() === new Date(hVal).toDateString();
                return d.getMonth() === bVal && d.getFullYear() === tVal;
            }).sort((a,b) => new Date(b.mulai) - new Date(a.mulai));

            filtered.forEach(o => {
                if(o.driverName) {
                    if(!stats[o.driverName]) stats[o.driverName] = { a:0, j:0 };
                    if(o.layanan === "ANTAR") stats[o.driverName].a++;
                    if(o.layanan === "JEMPUT") stats[o.driverName].j++;
                }
                
                // --- UPDATE RIWAYAT DRIVER DENGAN TANGGAL & JAM ---
                if(laundryMode === 'hari') {
                    const dt = new Date(o.mulai);
                    const jam = dt.toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
                    const tgl = dt.toLocaleDateString('id-ID', {day:'2-digit', month:'short', year:'numeric'});
                    
                    list.innerHTML += `
                    <div class="stat-card border-l-4 ${o.status === 'SELESAI' ? 'border-emerald-500' : 'border-blue-500'} mb-3">
                        <div class="flex justify-between items-start">
                            <div>
                                <h4 class="text-xs font-black text-white uppercase">${o.nama}</h4>
                                <p class="text-[9px] text-slate-500 font-bold uppercase mt-1">
                                    <i class="far fa-calendar-alt mr-1"></i> ${tgl} | <i class="far fa-clock mr-1"></i> ${jam}
                                </p>
                            </div>
                            <span class="text-[8px] font-black px-2 py-1 bg-white/5 rounded text-blue-500">${o.layanan}</span>
                        </div>
                        <div class="mt-2 pt-2 border-t border-white/5 flex justify-between items-center text-[9px] font-bold text-slate-300">
                            <span>DRIVER: ${o.driverName || 'PENDING'}</span>
                            <span class="${o.status === 'SELESAI' ? 'text-emerald-500' : 'text-blue-500'}">${o.status.replace('_',' ')}</span>
                        </div>
                    </div>`;
                }
            });

            Object.keys(stats).forEach(name => {
                recap.innerHTML += `
                <div class="stat-card flex justify-between items-center border-l-2 border-gold">
                    <div class="flex items-center gap-3">
                        <div class="w-10 h-10 rounded-full bg-gold/10 flex items-center justify-center text-gold"><i class="fas fa-user-tie"></i></div>
                        <div><p class="text-xs font-black text-white uppercase">${name}</p><p class="text-[9px] text-slate-500 font-bold uppercase">${laundryMode === 'hari' ? 'Hari Ini' : 'Bulan Ini'}</p></div>
                    </div>
                    <div class="text-right">
                        <p class="text-xl font-black text-white italic">${stats[name].a + stats[name].j} <span class="text-[9px] font-normal text-slate-400 not-italic">TRX</span></p>
                        <div class="flex gap-2 justify-end mt-1">
                            <span class="text-[8px] font-bold text-emerald-500">ðŸ›µ ${stats[name].a}</span>
                            <span class="text-[8px] font-bold text-blue-500">ðŸ§º ${stats[name].j}</span>
                        </div>
                    </div>
                </div>`;
            });
            if(Object.keys(stats).length === 0) recap.innerHTML = '<p class="text-center py-5 opacity-20 italic text-xs">Tidak ada data driver</p>';
        };

        window.switchPage = (id, btn) => {
            document.querySelectorAll('.page-content').forEach(p => p.classList.remove('active'));
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('nav-active', 'text-slate-500'));
            document.getElementById('page-'+id).classList.add('active');
            btn.classList.add('nav-active');
        };

        window.setModeKopi = (m) => {
            window.modeKopi = m;
            document.querySelectorAll('#page-kopi .tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('k-tab-'+m).classList.add('active');
            document.getElementById('k-wrap-hari').classList.toggle('hidden', m !== 'hari');
            document.getElementById('k-wrap-bt').classList.toggle('hidden', m === 'hari');
            renderKopi();
        };

        window.renderKopi = () => {
            if(!window.allKopi) return;
            const h = document.getElementById('k-input-hari').value;
            const m = parseInt(document.getElementById('k-input-bulan').value);
            const y = parseInt(document.getElementById('k-input-tahun').value);
            const list = document.getElementById('list-kopi');
            let total = 0; list.innerHTML = '';
            const filtered = window.allKopi.filter(t => {
                const d = new Date(t.tgl);
                if (window.modeKopi === 'hari') return d.toDateString() === new Date(h).toDateString();
                if (window.modeKopi === 'bulan') return d.getMonth() === m && d.getFullYear() === y;
                return d.getFullYear() === y;
            });
            filtered.forEach(t => {
                total += (t.total || 0);
                list.innerHTML += `<div class="stat-card flex justify-between items-center border-l-2 border-gold mb-2 py-3">
                    <div><p class="text-xs font-bold uppercase text-white">${t.nama || 'Customer'}</p><p class="text-[9px] text-slate-500">${new Date(t.tgl).toLocaleTimeString()}</p></div>
                    <p class="text-gold font-black">Rp ${(t.total || 0).toLocaleString()}</p>
                </div>`;
            });
            document.getElementById('k-total-display').innerText = "Rp " + total.toLocaleString();
        };

        window.paksaUpdateSistem = () => {
            if (confirm("Perbarui aplikasi ke versi terbaru?")) {
                if ('serviceWorker' in navigator) {
                    navigator.serviceWorker.getRegistrations().then(registrations => {
                        for(let registration of registrations) { registration.unregister(); }
                    });
                }
                window.location.href = window.location.pathname + '?v=' + new Date().getTime();
            }
        };

        window.onload = () => {
            const yr = new Date().getFullYear();
            const sK = document.getElementById('k-input-tahun');
            const sL = document.getElementById('l-select-tahun');
            for(let i=yr; i>=2024; i--) {
                const opt = `<option value="${i}">${i}</option>`;
                if(sK) sK.innerHTML += opt;
                if(sL) sL.innerHTML += opt;
            }
            document.getElementById('k-input-hari').valueAsDate = new Date();
            document.getElementById('l-input-date').valueAsDate = new Date();
            document.getElementById('k-input-bulan').value = new Date().getMonth();
            document.getElementById('l-select-bulan').value = new Date().getMonth();
            window.modeKopi = 'hari';
            renderLaundry();
        };
    </script>
</body>
</html>
