<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MACCA BOSS - HYBRID MODE</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        :root { --gold: #FFD700; --dark: #000000; --card: #141414; --emerald: #10b981; --cyan: #00E5FF; }
        
        body { margin: 0; font-family: 'Plus Jakarta Sans', sans-serif; background-color: #ffffff; transition: background-color 0.5s ease; }
        
        /* LOGIN OVERLAY */
        #login-screen { 
            position: fixed; inset: 0; background: #ffffff; z-index: 9999; 
            display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; 
        }
        .login-box { 
            background: #ffffff; padding: 40px 30px; border-radius: 40px; 
            border: 2px solid #e2e8f0; width: 100%; max-width: 360px; text-align: center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.1);
        }
        
        /* DASHBOARD */
        #main-dashboard { display: none; background-color: var(--dark); min-height: 100vh; color: #ffffff; }
        .stat-card { background: var(--card); border: 1px solid rgba(255,255,255,0.1); border-radius: 24px; padding: 22px; position: relative; overflow: hidden; }
        
        .section-title { font-size: 13px; font-weight: 800; color: #FFFFFF; letter-spacing: 1.5px; text-transform: uppercase; margin: 30px 0 15px 0; display: flex; align-items: center; gap: 10px; }
        .section-title::after { content: ""; flex: 1; height: 2px; background: linear-gradient(to right, rgba(255,255,255,0.2), transparent); }
        
        /* AKSEN DRIVER */
        .border-driver-0 { border-left: 8px solid #3b82f6; } 
        .border-driver-1 { border-left: 8px solid #a855f7; } 
        .border-driver-2 { border-left: 8px solid #f59e0b; } 
        .border-driver-3 { border-left: 8px solid #ec4899; } 
        .border-driver-4 { border-left: 8px solid #06b6d4; }
    </style>
</head>
<body class="antialiased">

    <div id="login-screen">
        <div class="login-box">
            <div class="w-24 h-24 bg-slate-900 rounded-full flex items-center justify-center mx-auto mb-6 shadow-xl">
                <i class="fas fa-crown text-yellow-400 text-4xl"></i>
            </div>
            <p class="text-slate-400 text-[10px] font-black uppercase tracking-[0.3em] mb-1">Authenticated Access</p>
            <h1 class="text-slate-800 text-xl font-bold uppercase mb-1">SELAMAT DATANG</h1>
            <h2 class="text-slate-900 text-4xl font-black italic uppercase mb-10">PAK BOSS</h2>
            
            <button onclick="unlockDashboard()" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl active:scale-95 transition-all uppercase tracking-widest shadow-2xl">
                MASUK SISTEM <i class="fas fa-arrow-right ml-2 text-yellow-400"></i>
            </button>
        </div>
    </div>

    <div id="main-dashboard" class="p-6 pb-24">
        <header class="flex justify-between items-center mb-10">
            <div>
                <h1 class="text-3xl font-black italic tracking-tighter uppercase leading-none text-white">MACCA <span class="text-red-500">BOSS</span></h1>
                <p class="text-[10px] font-extrabold text-white bg-red-600 px-2 py-0.5 rounded mt-1 inline-block uppercase">Authorized Only</p>
            </div>
            <button onclick="location.reload()" class="bg-zinc-800 p-4 rounded-2xl border border-white/10 text-white">
                <i class="fas fa-power-off"></i>
            </button>
        </header>

        <div class="section-title"><i class="fas fa-wallet text-gold"></i> Omzet Penjualan</div>
        <div class="grid grid-cols-1 gap-6">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="stat-card border-l-4 border-indigo-500">
                    <p class="text-white font-bold text-[11px] uppercase opacity-60">Kopi Shaka (Hari Ini)</p>
                    <h2 id="kopi-hari" class="text-4xl font-black italic text-indigo-400 mt-1">Rp 0</h2>
                </div>
                <div class="stat-card border-l-4 border-gold">
                    <p class="text-white font-bold text-[11px] uppercase opacity-60">Kopi Shaka (Bulan Ini)</p>
                    <h2 id="kopi-bulan" class="text-4xl font-black italic text-gold mt-1">Rp 0</h2>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="stat-card border-l-4 border-purple-500">
                    <p class="text-white font-bold text-[11px] uppercase opacity-60">Gerai Depan (Hari Ini)</p>
                    <h2 id="total-gerai" class="text-4xl font-black italic text-purple-400 mt-1">Rp 0</h2>
                    <div class="flex gap-4 mt-2 opacity-50 text-[9px] font-black uppercase tracking-tighter">
                        <span>QRIS: <span id="val-qris">Rp 0</span></span>
                        <span>CASH: <span id="val-cash">Rp 0</span></span>
                    </div>
                </div>

                <div class="stat-card border-l-4 border-emerald-500">
                    <p class="text-white font-bold text-[11px] uppercase opacity-60">Gerai Depan (Bulan Ini)</p>
                    <h2 id="total-gerai-bulan" class="text-4xl font-black italic text-emerald-400 mt-1">Rp 0</h2>
                    <div class="flex gap-4 mt-2 opacity-50 text-[9px] font-black uppercase tracking-tighter">
                        <span id="label-bulan" class="bg-emerald-500/20 text-emerald-400 px-2 py-0.5 rounded">JANUARI 2026</span>
                    </div>
                </div>
            </div>
        </div>

        <div class="section-title"><i class="fas fa-boxes text-orange-500"></i> Status Stok Dapur</div>
        <div class="grid grid-cols-2 gap-3">
            <div class="stat-card border-t-4 border-orange-500 text-center py-5">
                <p class="text-[11px] font-black text-white uppercase mb-1">A. Mentah</p>
                <h4 id="stok-mentah" class="text-4xl font-black italic text-orange-400">0</h4>
            </div>
            <div class="stat-card border-t-4 border-yellow-500 text-center py-5">
                <p class="text-[11px] font-black text-white uppercase mb-1">A. Ungkep</p>
                <h4 id="stok-ungkep" class="text-4xl font-black italic text-yellow-400">0</h4>
            </div>
            <div class="stat-card border-t-4 border-emerald-500 text-center py-5">
                <p class="text-[11px] font-black text-white uppercase mb-1">Ikan Tawar</p>
                <h4 id="stok-ikan" class="text-4xl font-black italic text-emerald-400">0</h4>
            </div>
            <div class="stat-card border-t-4 border-cyan-400 text-center py-5">
                <p class="text-[11px] font-black text-white uppercase mb-1">Ikan Laut</p>
                <h4 id="stok-ikanlaut" class="text-4xl font-black italic text-cyan-400">0</h4>
            </div>
        </div>

        <div class="section-title"><i class="fas fa-motorcycle text-cyan"></i> Rekap Poin Driver</div>
        <div id="driver-list" class="space-y-4"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const appKopi = initializeApp({ apiKey: "AIzaSyAf4pkzvpCuzmXquzIoCDXLAr6-_l3i8O0", projectId: "kopi-shaka" }, "KOPI");
        const dbKopi = getFirestore(appKopi);
        const appDeliv = initializeApp({ apiKey: "AIzaSyAWl_NXUXwt29rLArj79j8RlM8bY6kOCCg", projectId: "delivery-macca-new" }, "DELIV");
        const dbDeliv = getFirestore(appDeliv);

        onSnapshot(collection(dbKopi, "transactions"), (snap) => {
            let hariIni = 0;
            let bulanIni = 0;
            const now = new Date();
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();

            snap.forEach(doc => {
                const data = doc.data();
                if(!data.tgl) return;
                
                const tglTrans = new Date(data.tgl).getTime();
                const total = Number(data.total) || 0;

                if(tglTrans >= startToday) hariIni += total;
                if(tglTrans >= startMonth) bulanIni += total;
            });
            
            document.getElementById('kopi-hari').innerText = "Rp " + hariIni.toLocaleString();
            document.getElementById('kopi-bulan').innerText = "Rp " + bulanIni.toLocaleString();
        });

        onSnapshot(collection(dbDeliv, "orders"), (snap) => {
            window.dataDeliv = snap.docs.map(d => d.data());
            if(window.updateDriverStats) window.updateDriverStats();
        });
    </script>

    <script>
        function unlockDashboard() {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('main-dashboard').style.display = 'block';
            document.body.style.backgroundColor = "#000000";
        }

        const cfgStok = { apiKey: "AIzaSyCCmKgOnBFpluEKuycYjrBRm4zbxrHI1P8", databaseURL: "https://stocklistmacca-default-rtdb.asia-southeast1.firebasedatabase.app" };
        const cfgLaundry = { apiKey: "AIzaSyA-1GyDIS77tlL0vpiZS_ZLvx1S71TnkQU", databaseURL: "https://awwabim-laundry-default-rtdb.firebaseio.com" };
        
        firebase.initializeApp(cfgStok, "STOK_APP");
        firebase.initializeApp(cfgLaundry, "LAUNDRY_APP");
        const dbStok = firebase.app("STOK_APP").database();
        const dbLaundry = firebase.app("LAUNDRY_APP").database();

        let dataLaundry = [];

        dbStok.ref('stok_macca_v14_flow').on('value', snap => {
            let m=0, u=0, i=0, il=0;
            let qrisGerai=0, cashGerai=0;
            let totalBulanIni = 0;
            
            const now = new Date();
            const startToday = new Date(now.getFullYear(), now.getMonth(), now.getDate()).getTime();
            const startMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
            
            const monthNames = ["JANUARI", "FEBRUARI", "MARET", "APRIL", "MEI", "JUNI", "JULI", "AGUSTUS", "SEPTEMBER", "OKTOBER", "NOVEMBER", "DESEMBER"];
            document.getElementById('label-bulan').innerText = monthNames[now.getMonth()] + " " + now.getFullYear();

            snap.forEach(c => {
                const v = c.val();
                if(!v) return;

                const qty = Number(v.qty) || 0;
                const price = Number(v.price) || 0;
                const note = (v.note || "").toUpperCase();
                const time = v.time || 0;

                const flow = (v.status === 'Masuk' || v.status === 'TAMBAH') ? qty : -qty;
                if(v.type === 'Mentah') m+=flow; 
                else if(v.type === 'Ungkep') u+=flow; 
                else if(v.type === 'Ikan') i+=flow; 
                else if(v.type === 'IkanLaut') il+=flow;

                if(price > 0 && note.includes("GERAI DEPAN")) {
                    const subtotal = qty * price;
                    if(time >= startToday) {
                        if(note.includes("QRIS")) qrisGerai += subtotal;
                        else cashGerai += subtotal;
                    }
                    if(time >= startMonth) totalBulanIni += subtotal;
                }
            });

            document.getElementById('stok-mentah').innerText = m;
            document.getElementById('stok-ungkep').innerText = u;
            document.getElementById('stok-ikan').innerText = i;
            document.getElementById('stok-ikanlaut').innerText = il;
            
            document.getElementById('total-gerai').innerText = "Rp " + (qrisGerai + cashGerai).toLocaleString();
            document.getElementById('val-qris').innerText = "Rp " + qrisGerai.toLocaleString();
            document.getElementById('val-cash').innerText = "Rp " + cashGerai.toLocaleString();
            document.getElementById('total-gerai-bulan').innerText = "Rp " + totalBulanIni.toLocaleString();
        });

        dbLaundry.ref('Pesanan').on('value', snap => {
            dataLaundry = [];
            snap.forEach(c => { if(c.val().status === "SELESAI" && c.val().driverName) dataLaundry.push(c.val()); });
            updateDriverStats();
        });

        window.updateDriverStats = function() {
            const stats = {};
            dataLaundry.forEach(o => {
                const n = o.driverName.toUpperCase().trim();
                if(!stats[n]) stats[n] = { l: 0, d: 0 };
                stats[n].l++;
            });
            if(window.dataDeliv) {
                window.dataDeliv.forEach(o => {
                    if((o.status === "SELESAI" || o.status === "delivered") && o.driver) {
                        const n = o.driver.toUpperCase().trim();
                        if(!stats[n]) stats[n] = { l: 0, d: 0 };
                        stats[n].d++;
                    }
                });
            }

            let html = '';
            const sorted = Object.keys(stats).sort((a,b) => (stats[b].l + stats[b].d) - (stats[a].l + stats[a].d));

            sorted.forEach((name, index) => {
                const total = stats[name].l + stats[name].d;
                const point = total * 500;
                const colorIdx = index % 5;

                html += `
                <div class="stat-card border-driver-${colorIdx} py-6 shadow-xl">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <h4 class="font-black text-white text-lg tracking-tight uppercase mb-3">${name}</h4>
                            <div class="flex gap-4">
                                <div class="bg-blue-500/20 border border-blue-400/30 px-4 py-2 rounded-2xl text-center">
                                    <p class="text-[10px] font-black text-blue-300 uppercase leading-none mb-1">Laundry</p>
                                    <p class="text-2xl font-black text-blue-400 leading-none">${stats[name].l}</p>
                                </div>
                                <div class="bg-emerald-500/20 border border-emerald-400/30 px-4 py-2 rounded-2xl text-center">
                                    <p class="text-[10px] font-black text-emerald-300 uppercase leading-none mb-1">Delivery</p>
                                    <p class="text-2xl font-black text-emerald-400 leading-none">${stats[name].d}</p>
                                </div>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-4xl font-black text-gold italic leading-none">${point.toLocaleString()}</p>
                            <p class="text-[10px] font-black text-white bg-zinc-700 px-2 py-1 rounded-md mt-2 uppercase">Total Poin</p>
                        </div>
                    </div>
                </div>`;
            });
            document.getElementById('driver-list').innerHTML = html || '<p class="text-center py-10 text-white/20 italic">No Data</p>';
        };
    </script>
</body>
</html>
